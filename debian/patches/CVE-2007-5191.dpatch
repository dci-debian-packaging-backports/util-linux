#! /bin/sh /usr/share/dpatch/dpatch-run
## CVE-2007-5191.dpatch
##
## All lines beginning with `## DP:' are a description of the patch.
## DP: Include patch to fix CVE-2007-5191

@DPATCH@
--- mount.c.orig	2007-10-06 07:09:43.000000000 +0000
+++ util-linux-2.12r/mount/mount.c	2007-10-06 07:11:27.000000000 +0000
@@ -736,8 +736,12 @@
 		 const char *oo, *mountargs[10];
 		 int i = 0;
 
-		 setuid(getuid());
-		 setgid(getgid());
+		 if(setgid(getgid()) < 0)
+		     die(EX_FAIL, _("mount: cannot set group id: %s"), strerror(errno));
+		 
+		 if(setuid(getuid()) < 0)
+		     die(EX_FAIL, _("mount: cannot set user id: %s"), strerror(errno));
+
 		 oo = fix_opts_string (flags, extra_opts, NULL);
 		 mountargs[i++] = mountprog;
 		 mountargs[i++] = spec;
--- umount.c.orig	2007-10-06 07:12:23.000000000 +0000
+++ util-linux-2.12r/mount/umount.c	2007-10-06 07:13:42.000000000 +0000
@@ -113,8 +113,12 @@
 				char *umountargs[8];
 				int i = 0;
 
-				setuid(getuid());
-				setgid(getgid());
+			if(setgid(getgid()) < 0)
+                                die(EX_FAIL, _("umount: cannot set group id: %s"), strerror(errno));
+
+                        if(setuid(getuid()) < 0)
+                                die(EX_FAIL, _("umount: cannot set user id: %s"), strerror(errno));
+	
 				umountargs[i++] = umountprog;
 				umountargs[i++] = xstrdup(node);
 				if (nomtab)
